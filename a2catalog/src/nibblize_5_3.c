#ifdef HAVE_CONFIG_H
#include <config.h>
#endif

#include "nibblize_5_3.h"

#include <stdint.h>
#include <string.h>
#include <stdlib.h>

#include "assert_that.h"



void nibblize_5_3_encode(const uint8_t** original, uint8_t** encoded) {
	(void)original;
	(void)encoded;
}
void nibblize_5_3_decode(const uint8_t** original, uint8_t** decoded) {
	(void)original;
	(void)decoded;
}

static const uint8_t dos31_t0s1_log[] = {
  0x8e, 0xe9, 0x37, 0x8e, 0xf7, 0x37, 0xa9, 0x01, 0x8d, 0xf8, 0x37, 0x8d, 0xea, 0x37, 0xad, 0xe0,
  0x37, 0x8d, 0xe1, 0x37, 0xa9, 0x00, 0x8d, 0xec, 0x37, 0xad, 0xe2, 0x37, 0x8d, 0xed, 0x37, 0xad,
  0xe3, 0x37, 0x8d, 0xf1, 0x37, 0xa9, 0x01, 0x8d, 0xf4, 0x37, 0x8a, 0x4a, 0x4a, 0x4a, 0x4a, 0xaa,
  0xa9, 0x00, 0x9d, 0xf8, 0x04, 0x9d, 0x78, 0x04, 0x20, 0x93, 0x37, 0xa2, 0xff, 0x9a, 0x8e, 0xeb,
  0x37, 0x20, 0x93, 0xfe, 0x20, 0x89, 0xfe, 0x4c, 0x03, 0x1b, 0xad, 0xf1, 0x37, 0x8d, 0xe3, 0x37,
  0x38, 0xad, 0xe7, 0x37, 0xed, 0xe3, 0x37, 0x8d, 0xe0, 0x37, 0xa9, 0x00, 0x8d, 0xec, 0x37, 0x8d,
  0xed, 0x37, 0x8d, 0xf0, 0x37, 0xad, 0xe7, 0x37, 0x8d, 0xf1, 0x37, 0x8d, 0xfe, 0x36, 0xa9, 0x0a,
  0x8d, 0xe1, 0x37, 0x8d, 0xe2, 0x37, 0xa9, 0x48, 0x8d, 0xff, 0x36, 0xa9, 0x02, 0x8d, 0xf4, 0x37,
  0x20, 0x93, 0x37, 0xad, 0xe3, 0x37, 0x8d, 0xf1, 0x37, 0xad, 0xe0, 0x37, 0x8d, 0xe1, 0x37, 0x20,
  0x93, 0x37, 0x60, 0xad, 0xe5, 0x37, 0xac, 0xe4, 0x37, 0x20, 0x00, 0x3d, 0xac, 0xed, 0x37, 0xc8,
  0xc0, 0x0d, 0xd0, 0x05, 0xa0, 0x00, 0xee, 0xec, 0x37, 0x8c, 0xed, 0x37, 0xee, 0xf1, 0x37, 0xce,
  0xe1, 0x37, 0xd0, 0xdf, 0x60, 0xa9, 0x0c, 0x20, 0x38, 0x22, 0xa9, 0x06, 0xcd, 0xf9, 0x34, 0xd0,
  0x03, 0x4c, 0xb2, 0x23, 0x4c, 0x78, 0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x1b, 0x09, 0x0a, 0x1b, 0xe8, 0x37, 0x00, 0x36, 0x01, 0x60, 0x01, 0xfe, 0x00, 0x01, 0xfb, 0x37,
  0x00, 0x37, 0x00, 0x00, 0x02, 0xff, 0xfe, 0x60, 0x01, 0x00, 0x00, 0x00, 0x01, 0xef, 0xd8, 0x00
};
static const size_t dos31_t0s1_log_len = 256;

static const uint8_t dos31_t0s1_phy[] = {
  0xab, 0xfd, 0xfa, 0xd7, 0xfb, 0xae, 0xbe, 0xdd, 0xbb, 0xdb, 0xae, 0xf5, 0xfb, 0xed, 0xae, 0xee,
  0xf5, 0xbb, 0xbe, 0xab, 0xbf, 0xad, 0xbf, 0xaf, 0xbd, 0xb5, 0xba, 0xdf, 0xf7, 0xbb, 0xbe, 0xbf,
  0xbe, 0xeb, 0xdd, 0xbd, 0xb7, 0xd7, 0xbf, 0xef, 0xd6, 0xab, 0xab, 0xab, 0xab, 0xad, 0xd6, 0xbb,
  0xae, 0xba, 0xae, 0xb5, 0xad, 0xaf, 0xdf, 0xbf, 0xfb, 0xbd, 0xfe, 0xbe, 0xaf, 0xef, 0xbb, 0xaf,
  0xbb, 0xba, 0xfe, 0xd7, 0xbd, 0xbf, 0xfb, 0xed, 0xae, 0xbd, 0xee, 0xad, 0xed, 0xd6, 0xba, 0xbf,
  0xf5, 0xb5, 0xde, 0xae, 0xb7, 0xda, 0xba, 0xf5, 0xad, 0xab, 0xb6, 0xea, 0xdf, 0xab, 0xab, 0xab,
  0xad, 0xbb, 0xde, 0xfa, 0xfe, 0xb6, 0xf7, 0xf6, 0xb6, 0xad, 0xfe, 0xb7, 0xdd, 0xbb, 0xf7, 0xed,
  0xf5, 0xfe, 0xb5, 0xdb, 0xfd, 0xf6, 0xfb, 0xb7, 0xda, 0xbe, 0xde, 0xbd, 0xf5, 0xae, 0xde, 0xab,
  0xab, 0xbf, 0xf7, 0xde, 0xbf, 0xdb, 0xb7, 0xeb, 0xad, 0xee, 0xd6, 0xf6, 0xbe, 0xf5, 0xfe, 0xd6,
  0xab, 0xab, 0xab, 0xab, 0xb6, 0xb6, 0xf6, 0xf6, 0xfb, 0xfe, 0xae, 0xff, 0xff, 0xff, 0xff, 0xad,
  0xad, 0xab, 0xab, 0xab, 0xab, 0xb5, 0xae, 0xae, 0xbb, 0xed, 0xb5, 0xfd, 0xf5, 0xff, 0xdf, 0xea,
  0xef, 0xdb, 0xf5, 0xef, 0xab, 0xab, 0xb5, 0xbf, 0xf5, 0xef, 0xb5, 0xbd, 0xfa, 0xf6, 0xad, 0xfa,
  0xfa, 0xff, 0xea, 0xf7, 0xef, 0xab, 0xf5, 0xea, 0xab, 0xbd, 0xf7, 0xab, 0xef, 0xde, 0xff, 0xf6,
  0xb7, 0xb7, 0xba, 0xad, 0xab, 0xab, 0xab, 0xab, 0xbd, 0xea, 0xdb, 0xab, 0xbd, 0xf7, 0xfa, 0xfb,
  0xeb, 0xbd, 0xdd, 0xdd, 0xf7, 0xea, 0xbf, 0xad, 0xaf, 0xfd, 0xba, 0xea, 0xbb, 0xfd, 0xb7, 0xea,
  0xea, 0xdb, 0xfa, 0xad, 0xef, 0xfa, 0xee, 0xdb, 0xab, 0xea, 0xbd, 0xfb, 0xb7, 0xef, 0xb5, 0xbb,
  0xfd, 0xd6, 0xd6, 0xab, 0xab, 0xaf, 0xaf, 0xab, 0xab, 0xab, 0xab, 0xdb, 0xdb, 0xab, 0xad, 0xba,
  0xfa, 0xab, 0xba, 0xba, 0xfa, 0xea, 0xea, 0xea, 0xbd, 0xf7, 0xab, 0xab, 0xef, 0xab, 0xd7, 0xf7,
  0xef, 0xab, 0xd7, 0xd7, 0xde, 0xff, 0xda, 0xaf, 0xdf, 0xed, 0xb5, 0xb5, 0xbd, 0xf7, 0xef, 0xab,
  0xd6, 0xfd, 0xb7, 0xfa, 0xfd, 0xab, 0xff, 0xea, 0xde, 0xfd, 0xab, 0xab, 0xab, 0xab, 0xb5, 0xd7,
  0xdd, 0xfd, 0xfe, 0xb5, 0xf5, 0xb7, 0xb7, 0xae, 0xf5, 0xf5, 0xf5, 0xf7, 0xae, 0xde, 0xab, 0xbd,
  0xaf, 0xf6, 0xef, 0xd6, 0xad, 0xf7, 0xf7, 0xff, 0xba, 0xf6, 0xfa, 0xed, 0xb7, 0xfb, 0xbd, 0xb7,
  0xef, 0xd6, 0xad, 0xf7, 0xef, 0xab, 0xbe, 0xfa, 0xab, 0xb7, 0xb7, 0xb7, 0xb6, 0xaf, 0xab, 0xab,
  0xab, 0xab, 0xee, 0xbd, 0xf5, 0xfb, 0xfd, 0xef, 0xb6, 0xd7, 0xf6, 0xb7, 0xeb, 0xeb, 0xef, 0xaf,
  0xdf, 0xbd, 0xdb, 0xab, 0xef, 0xdb, 0xf5, 0xab, 0xfa, 0xfa, 0xea, 0xb5, 0xef, 0xdf, 0xfa, 0xdb,
  0xbd, 0xf5, 0xab, 0xd6, 0xfa, 0xab, 0xea, 0xbe, 0xad, 0xfe, 0xab
};
static const size_t dos31_t0s1_phy_len = 411;

void test_nibblize_5_3_encode(ctx_assertion* ctx) {
	const uint8_t *po = dos31_t0s1_log;
	const size_t c = dos31_t0s1_phy_len*sizeof(uint8_t);
	uint8_t *penc = (uint8_t*)malloc(c);
	uint8_t *pend = penc+c;
	uint8_t *p = penc;
	uint8_t *i = penc;

	memset(p,0x75,c);
	nibblize_5_3_encode(&po,&p);
	ASSERT_THAT(ctx,"nibblize_5_3_encode write pointer",p==pend);
	ASSERT_THAT(ctx,"nibblize_5_3_encode read pointer",po==dos31_t0s1_log+dos31_t0s1_log_len);

	po = dos31_t0s1_log;
	while (i != pend) {
		ASSERT_THAT(ctx,"nibblize_5_3_encode",*i++==*po++); 
	}

	free(penc);
}

void test_nibblize_5_3_decode(ctx_assertion* ctx) {
	const uint8_t *po = dos31_t0s1_phy;
	const size_t c = dos31_t0s1_log_len*sizeof(uint8_t);
	uint8_t *pdec = (uint8_t*)malloc(c);
	uint8_t *pend = pdec+c;
	uint8_t *p = pdec;
	uint8_t *i = pdec;

	memset(p,0xFA,c);
	nibblize_5_3_decode(&po,&p);
	ASSERT_THAT(ctx,"nibblize_5_3_decode write pointer",p==pend);
	ASSERT_THAT(ctx,"nibblize_5_3_decode read pointer",po==dos31_t0s1_phy+dos31_t0s1_phy_len);

	po = dos31_t0s1_log;
	while (i != pend) {
		ASSERT_THAT(ctx,"nibblize_5_3_decode",*i++==*po++); 
	}

	free(pdec);
}

void test_nibblize_5_3(ctx_assertion* ctx) {
	test_nibblize_5_3_encode(ctx);
	test_nibblize_5_3_decode(ctx);
}
